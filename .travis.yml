sudo: required

language: cpp

cache:
  directories:
    - /opt/devkitpro/pacman/var/cache/pacman/pkg/

git:
  submodules: false

before_install:
  - sed -i 's/git@github.com:/git:\/\/github.com\//' .gitmodules # Travis can't deal with the user 'git'...
  - echo -e "\n\nmachine github.com\n  login $GITHUB_TOKEN\n" >~/.netrc
  - git submodule update --init --recursive
  - wget https://github.com/devkitPro/pacman/releases/download/devkitpro-pacman-1.0.1/devkitpro-pacman.deb
  - sudo dpkg -i devkitpro-pacman.deb
  - sudo dkp-pacman -S switch-{dev,curl,portlibs,glfw,mesa,glm} libnx --noconfirm
  - source /etc/profile.d/devkit-env.sh

script:
  - make -j8

before_deploy:
    - git config --local user.name "WerWolv"
    - git config --local user.email "werwolv98@gmail.com"
    - export TRAVIS_TAG=snapshot
    - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
    - git tag $TRAVIS_TAG
  
deploy:
  provider: releases
  prerelease: true
  api_key: $GITHUB_TOKEN
  file: application/out/EdiZon.nro
  skip_cleanup: true
  overwrite: true
  name: "Snapshot Build"
  body: "This build was compiled on the $(date +'%d.%m.%Y'). It may be unstable, contains more features and bug fixes too though"
  on:
    branch: master